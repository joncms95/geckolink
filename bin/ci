#!/usr/bin/env bash
set -e

# Run format, lint, security scan, and tests.
readonly RUFO_MAX_ATTEMPTS=5

run_section() {
  echo ""
  echo "═══════════════════════════════════════════════════════════════"
  echo "  $1"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
}

# Format with Rufo until --check passes (Rufo can need multiple passes to converge).
rufo_format_until_clean() {
  local attempt=0
  while [ "$attempt" -lt "$RUFO_MAX_ATTEMPTS" ]; do
    bundle exec rufo . || true
    bundle exec rufo --check . && return 0
    attempt=$((attempt + 1))
    [ "$attempt" -lt "$RUFO_MAX_ATTEMPTS" ] && echo "  Rufo: re-running format (pass $((attempt + 1))/${RUFO_MAX_ATTEMPTS})"
  done
  echo "Rufo did not converge after ${RUFO_MAX_ATTEMPTS} passes." >&2
  exit 1
}

run_section "1/5  Rufo (Ruby format)"
rufo_format_until_clean

run_section "2/5  Prettier (client format)"
npm run format --prefix client

run_section "3/5  RuboCop (lint & auto-correct)"
bin/rubocop -A

run_section "4/5  Brakeman (security scan)"
bin/brakeman --no-pager

run_section "5/5  RSpec (tests)"
bundle exec rspec

run_section "All checks passed."
echo ""
